# gh-mutual-follow 開発対応内容

## 1. プロジェクト初期設定

-   `README.md` の読み込みとプロジェクト要件の理解
-   `internal/cli` および `internal/tui` ディレクトリの作成
-   `main.go`, `internal/cli/cli.go`, `internal/cli/cli_test.go` の初期ファイル作成
-   Go 依存関係 (`bubbletea`, `lipgloss`, `bubbles/textarea`) のインストール

## 2. GitHub CLI 連携ロジック (`internal/cli` パッケージ)

-   `gh` CLI ツールとの連携のため、`internal/cli/cli.go` に以下の関数を実装:
    -   `GetUser()`: 認証済み GitHub ユーザー名の取得
    -   `GetFollowing(user string)`: 指定ユーザーがフォローしているユーザーリストの取得
    -   `GetFollowers(user string)`: 指定ユーザーをフォローしているユーザーリストの取得
    -   `Unfollow(user string)`: 指定ユーザーのアンフォロー
    -   `Follow(user string)`: 指定ユーザーのフォロー
    -   `GetMutualFollowsData(authenticatedUser string, following, followers []string)`: 相互フォローでないユーザーリストの生成 (「Following」と「Followers」)
-   `internal/cli/cli_test.go` にモックを使用した単体テストを実装し、上記関数の動作を検証
-   **ページネーション対応**: `gh api` コマンドに `--paginate` フラグを追加し、全フォロワー/フォロー中ユーザーを取得するように修正
-   **エラーメッセージの詳細化**: `runCommand` 関数を修正し、`gh` CLI コマンド失敗時に `stderr` の内容をエラーメッセージに含めるように変更。

## 3. ユーザーインターフェース (TUI) 実装 (`main.go`)

-   Bubble Tea フレームワークを使用した TUI の基本構造を `main.go` に実装:
    -   `model` 構造体の定義: アプリケーションの状態 (ユーザー名、リストデータ、アクティブなペイン、ローディング状態、エラー、スタイルなど) を管理
    -   `TUIStyles` 構造体と `defaultStyles()`: `lipgloss` を用いた UI スタイルの定義
    -   `item` 型と `FilterValue()` メソッド: `bubbles/list` コンポーネントで表示するアイテムの定義
    -   `itemDelegate` 構造体とメソッド: `bubbles/list` のアイテム表示をカスタマイズ
    -   `dataLoadedMsg`, `errorMsg`, `statusMsg` 型: 非同期処理および一時的なステータスメッセージのためのメッセージタイプ
    -   `clearStatusMsg()`: 一時的なステータスメッセージをクリアするコマンド
    -   `initialModel()`: アプリケーション初期状態のモデルを生成
    -   `Init()`: 初期データロードコマンド (`loadDataCmd()`) をトリガー
    -   `Update()`: キー入力、非同期メッセージ、ウィンドウサイズ変更イベントに応じたアプリケーションの状態更新ロジック
    -   `View()`: 現在のモデル状態に基づいた UI の描画ロジック (ヘッダー、2ペイン、フッター、ステータスメッセージ)

## 4. 主な機能追加と修正

-   **メイン関数の追加**: アプリケーションのエントリーポイントである `func main()` を追加し、Bubble Tea プログラムを実行
-   **エラー処理**: データロード時やアクション実行時のエラー表示
-   **アクティブペインの切り替え**: `Tab` / `Shift+Tab` キーによる左右ペインの切り替え
-   **データのリフレッシュ**: `r` キーによるデータ再ロード
-   **個別アクション**: `Enter` キーによる選択されたユーザーのフォロー/アンフォロー機能
-   **一時的なステータスメッセージ**: アクション実行後にフィードバックを数秒間表示
-   **一括アクション**: `a` キーによるアクティブペイン内の全ユーザーの一括フォロー/アンフォロー機能
    -   一括処理中はUIを「Working...」表示にし、他のキー入力を無視
-   **ヘルプテキストの改善**: フッターに利用可能なキーバインドを詳細に表示 (`[↑↓] Move`, `[←→] Page`, `[enter] Action`, `[a] Action All`)
-   **レイアウトと表示件数の調整**:
    -   **ページネーションの修正**: `initialModel`にて`Paginator.PerPage = 10`を設定し、1ページあたりの表示件数を10に指定。
    -   `Update`メソッドの`WindowSizeMsg`ハンドラで`list.Model`の表示高さを`15`に設定（環境依存のオーバーヘッドを考慮した試行錯誤の結果）。
    -   `defaultStyles`の`s.Pane`および`s.FocusedPane`に`Height(16)`を明示的に設定し、リストコンテンツ（10行）とタイトル、パディング、ボーダーの合計を収めるように調整。
    -   この調整により、期待通り**10件のアイテム**が表示され、レイアウトも改善、ページングも機能するように修正。

## 5. 発生した問題と解決

-   **GitHub CLI未ログイン**: `gh auth login` の実行をユーザーに依頼
-   **`go run main.go` の問題**:
    -   当初、`go run main.go` が複数パッケージ構成のプロジェクトで機能しないことを説明し、`go run .` の使用を提案。
    -   ユーザーの指示に従い `go run main.go` を続行した結果、`runtime.main_main·f: function main is undeclared in the main package` エラーが頻発。
    -   これは、`main`関数が `main.go` に存在しないという私の見落としが原因であったことをユーザーの指摘により修正。
-   **未使用 `os` import**: ユーザーの指摘を受け、`os` import を削除するも問題の根本原因ではなかったため最終的に`main`関数内で使用するように再導入。
-   **`lipgloss` 構文エラー**: `defaultStyles()` 関数内でメソッドチェーンのカンマとピリオドを誤って使用していた構文エラーを修正。
-   **`loadDataCmd` シグネチャエラー**: `model` メソッドとしての `loadDataCmd` の定義が誤っていたのを修正。
-   **`Update` メソッドの構文エラー**: `Update` 関数内で余分な閉じ括弧 `}` や `case` の配置ミスが存在し、構文エラーを引き起こしていたのを複数回にわたり修正。
-   **`isBulkActionInProgress` 状態管理**: 一括アクション完了後に `isBulkActionInProgress` が `false` にリセットされないバグを修正。
-   **`list.Model.Focus()/Blur()` の誤用**: `bubbles/list`に存在しないメソッドを呼び出そうとしていたため修正。
-   **表示件数とレイアウトの崩れ、ページング機能不全**:
    -   `gh api` コマンドの `--paginate` フラグを有効化し、全件取得できるように修正。
    -   `list.Model` の高さ設定がターミナル環境で意図通りに機能しない問題に対し、手動レンダリングによる診断を実施。
    -   `bubbles/list` の `list.New` オプション (`list.WithHeight`) のバージョン違いによる誤用を修正。
    -   最終的に、`list.Model` に与える高さと `lipgloss` ペインに与える高さを試行錯誤により調整（`list.SetHeight(15)` および `lipgloss.Height(16)`）。これにより、10件のアイテムが正しく表示され、ページングも機能するように修正。
-   **アクション実行時のエラー (権限不足)**:
    -   `gh api` コマンド失敗時に `stderr` を含む詳細なエラーメッセージを返すように `internal/cli/runCommand` を修正。
    -   ユーザーの GitHub CLI 認証トークンに `user` スコープが不足していたため、`gh auth refresh -h github.com -s user` の実行を指示し、問題が解決されたことを確認。

以上の対応により、アプリケーションは機能する状態になりました。
